<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Stream with SVG Overlay</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }
        #video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        #video-frame {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .svg-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .bbox-text {
            fill: white;
            font-size: 12px;
            font-family: Arial, sans-serif;
            text-anchor: middle;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <img id="video-frame" alt="Video Stream">
        <div id="svg-container" class="svg-container"></div>
    </div>
<script>
    let lastBboxes = []; // Store the latest bounding boxes for redrawing on resize

    const socket = new WebSocket('ws://localhost:5678');
    socket.binaryType = 'arraybuffer'; // Receive messages as ArrayBuffers

    socket.onmessage = function(event) {
        const dataView = new DataView(event.data);
        const jsonLength = dataView.getUint32(0); // First 4 bytes represent the JSON length
        const jsonString = new TextDecoder().decode(event.data.slice(4, 4 + jsonLength));
        const bboxesInfo = JSON.parse(jsonString);
        lastBboxes = bboxesInfo.bboxes; // Update global bounding boxes

        // Remaining bytes are the image data
        const imageData = event.data.slice(4 + jsonLength);
        const blob = new Blob([imageData], {type: "image/jpeg"});
        const url = URL.createObjectURL(blob);
        document.getElementById('video-frame').src = url;

        // Wait for the image to load before adjusting overlays
        document.getElementById('video-frame').onload = () => adjustOverlays(lastBboxes);
    };

    function adjustOverlays(bboxes) {
        const videoFrame = document.getElementById('video-frame');
        const container = videoFrame.parentElement;
        const svgContainer = document.getElementById('svg-container');
        svgContainer.innerHTML = ''; // Clear previous overlays

        // Determine if letterboxing or pillarboxing occurs
        const videoRatio = videoFrame.naturalWidth / videoFrame.naturalHeight;
        const containerRatio = container.offsetWidth / container.offsetHeight;
        let scale, offsetX, offsetY;

        if (containerRatio > videoRatio) {
            // Pillarboxing (bars on the sides)
            scale = container.offsetHeight / videoFrame.naturalHeight;
            offsetX = (container.offsetWidth - scale * videoFrame.naturalWidth) / 2;
            offsetY = 0;
        } else {
            // Letterboxing (bars on the top and bottom)
            scale = container.offsetWidth / videoFrame.naturalWidth;
            offsetX = 0;
            offsetY = (container.offsetHeight - scale * videoFrame.naturalHeight) / 2;
        }

        bboxes.forEach((bbox, index) => {
            const rectX = bbox.x * scale + offsetX;
            const rectY = bbox.y * scale + offsetY;
            const rectWidth = bbox.width * scale;
            const rectHeight = bbox.height * scale;
            console.log(bbox)
            const textContent = `${bbox.category},${bbox.distance},${bbox.bearing}`;

            // SVG for bounding box
            const bboxSvgElement = `<svg width="${rectWidth}" height="${rectHeight}" style="position: absolute; left: ${rectX}px; top: ${rectY}px;">
                <rect width="100%" height="100%" fill="none" stroke="yellow" stroke-width="2"/>
            </svg>`;

          const textSvgX = rectX - 10;
          const textSvgY = rectY -50;

          // SVG for text, positioned to the left of the bounding box and rotated
          const textSvgElement = `<svg style="position: absolute; left: ${textSvgX}px; top: ${textSvgY}px;">
            <text x="-15" y="0" transform="rotate(-90, 15, 0)" class="bbox-text">${textContent}</text>
          </svg>`;


            svgContainer.insertAdjacentHTML('beforeend', bboxSvgElement + textSvgElement);
        });
    }

    // Handle window resize to adjust overlays
    window.addEventListener('resize', () => {
        if (lastBboxes.length > 0) {
            adjustOverlays(lastBboxes);
        }
    });
</script>
</body>
</html>
